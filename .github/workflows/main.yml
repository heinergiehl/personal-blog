name: CI/CD – MyPortfolio

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      APP_PORT: 3002

    steps:
      # 1) Checkout your repo
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Setup Node (gets you npm too)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # (Optional) If you actually need a .env on the RUNNER, keep this.
      # For your current flow (build happens on the server), you can delete this step.
      - name: Create .env.production (runner) # optional
        run: |
          cat > .env.production <<EOF
          APP_PORT=${{ env.APP_PORT }}
          PRODUCTION=true
          # NEXT_PUBLIC_FOO=${{ secrets.NEXT_PUBLIC_FOO }}
          EOF

      # ⚠️ No need to build locally since we build on the server
      # - name: Install & Build (runner)
      #   run: |
      #     npm ci
      #     npm run build

      # 3) Deploy over SSH and build on the VPS
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            # A) Ensure repo exists
            if [ ! -d /var/www/latest-portfolio/.git ]; then
              echo "❌ /var/www/latest-portfolio is not a git repo."
              echo "Make sure you've cloned the repo there first, e.g.:"
              echo "  git clone git@github.com:heinergiehl/personal-blog.git /var/www/latest-portfolio"
              exit 1
            fi

            cd /var/www/latest-portfolio

            # B) Update code
            git fetch --all
            git reset --hard origin/main

            # C) Write env BEFORE build (Next.js needs build-time env)
            cat > .env.production <<EOF
            APP_PORT=${{ env.APP_PORT }}
            PRODUCTION=true
            # add other env as needed...
            EOF

            # D) Install & build (use ci for clean installs)
            npm ci
            npm run build

            # E) Reload pm2 (start if not running)
            if pm2 list | grep -q "latest-portfolio"; then
              pm2 reload ecosystem.config.js --only latest-portfolio --env production
            else
              pm2 start ecosystem.config.js --only latest-portfolio --env production
            fi

            # F) Persist pm2 (optional, first time only)
            pm2 save
