name: CI/CD â€“ MyPortfolio

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      APP_PORT: 3002
      DEPLOY_DIR: /var/www/latest-portfolio
      GH_REPO: heinergiehl/personal-blog
      GH_BRANCH: main

    steps:
      - name: Deploy to VPS (pull, build, restart)
        uses: appleboy/ssh-action@v0.1.7
        env:
          GH_TOKEN: ${{ secrets.GH_DEPLOY_TOKEN }}
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          port: ${{ secrets.DEPLOY_PORT }} # set this, or remove if you truly use 22
          key: ${{ secrets.SSH_PRIVATE_KEY }} # <-- IMPORTANT: use your real secret name
          command_timeout: 30m
          envs: APP_PORT,DEPLOY_DIR,GH_REPO,GH_BRANCH,GH_TOKEN
          script: |
            set -euo pipefail

            echo "--- Server time ---"
            date

            echo "--- Ensure deploy dir exists ---"
            mkdir -p "$(dirname "$DEPLOY_DIR")"

            if [ ! -d "$DEPLOY_DIR/.git" ]; then
              echo "--- Fresh clone ---"
              rm -rf "$DEPLOY_DIR"
              git clone --branch "$GH_BRANCH" "https://x-access-token:${GH_TOKEN}@github.com/${GH_REPO}.git" "$DEPLOY_DIR"
            else
              echo "--- Update existing repo ---"
              cd "$DEPLOY_DIR"
              git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${GH_REPO}.git"
              git fetch origin "$GH_BRANCH"
              git reset --hard "origin/$GH_BRANCH"
            fi

            cd "$DEPLOY_DIR"

            echo "--- Write .env.production ---"
            cat > .env.production <<EOF
            APP_PORT=${APP_PORT}
            PRODUCTION=true
            EOF

            echo "--- Commit on server ---"
            git log --oneline -1

            echo "--- Bun check ---"
            command -v bun >/dev/null 2>&1 || (echo "Bun missing on VPS" && exit 1)

            echo "--- Install + build ---"
            bun install --frozen-lockfile || bun install
            rm -rf .next/cache || true
            bun run build

            echo "--- PM2 restart ---"
            command -v pm2 >/dev/null 2>&1 || (echo "PM2 missing on VPS" && exit 1)
            pm2 startOrReload ecosystem.config.js --only blog --env production
            pm2 status

            echo "--- Health ---"
            curl -s -I "http://localhost:${APP_PORT}" | head -20 || true
