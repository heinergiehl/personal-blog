name: CI/CD â€“ MyPortfolio
on:
  push:
    branches: [main]
jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      # Change this if your app listens on a different port
      APP_PORT: 3002
    steps:
      # 1) Checkout your repo
      - name: Checkout
        uses: actions/checkout@v3
      # 2) Install Bun
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "latest"
      # 3) (Optional) Create .env.production on the runner
      #    Only include the vars your app actually needs.
      - name: Create .env.production
        run: |
          cat > .env.production <<EOF
          APP_PORT=${{ env.APP_PORT }}
          PRODUCTION=true
          # Add any other secrets here:
          # NEXT_PUBLIC_FOO=${{ secrets.NEXT_PUBLIC_FOO }}
          EOF
      # 4) Install & build
      - name: Install & Build
        run: |
          bun install
          bun run build
      # 5) Prepare SSH key
      - name: Copy SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
      # 6) SSH into VPS and deploy
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo '--- Preflight: ensure GitHub host key ---'
            mkdir -p ~/.ssh
            if ! grep -q github.com ~/.ssh/known_hosts 2>/dev/null; then
              ssh-keyscan -t ed25519 github.com >> ~/.ssh/known_hosts
              chmod 644 ~/.ssh/known_hosts
            fi

            echo '--- Environment file ---'
            cat > /var/www/latest-portfolio/.env.production <<EOF
            APP_PORT=${{ env.APP_PORT }}
            PRODUCTION=true
            EOF

            echo '--- Go to project dir ---'
            cd /var/www/latest-portfolio

            if [ ! -d .git ]; then
              echo 'ERROR: /var/www/latest-portfolio is not a git repo. Did you clone it initially?'
              exit 1
            fi

            echo 'Remote URL:'
            git remote -v

            echo '--- Test SSH auth to GitHub ---'
            if ssh -T -o BatchMode=yes git@github.com 2>&1 | grep -qi 'permission denied'; then
              echo 'ERROR: GitHub SSH auth failed. Ensure deploy key public part is added to repo Deploy Keys.'
              exit 1
            fi

            echo '--- Pull & build ---'
            git fetch origin
            git checkout main
            git pull --ff-only origin main

            bun install
            bun run build
            pm2 reload ecosystem.config.js --only latest-portfolio --env production
